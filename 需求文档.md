# Vue Cesium Ultimate 项目需求文档

## 项目概述

本项目是一个基于 Vue 3 和 Cesium 的三维地球数据可视化平台，主要用于展示目标点位、关系连线和各种动态效果。

## 核心功能模块

### 1. 地图可视化模块

#### 1.1 基础地图功能
- [x] Cesium 地球初始化
- [x] 地图控制（缩放、旋转、平移）
- [x] 相机视角控制
- [x] 地形和影像加载

#### 1.2 目标点位管理
- [x] 目标点位数据结构定义
- [x] 目标点位渲染（支持多种类型图标）
- [x] 目标点位交互（点击、悬停）
- [x] 目标信息面板展示
- [ ] **组件化需求**: 封装 `TargetMarker` 组件
- [ ] **组件化需求**: 封装 `TargetInfoPanel` 组件

### 2. 关系连线模块

#### 2.1 基础连线功能
- [x] 普通关系连线（直线）
- [x] 飞线效果连线
- [x] 脉冲效果连线
- [x] 抛物线轨迹连线
- [ ] **组件化需求**: 封装 `RelationLine` 组件

#### 2.2 材质系统
- [x] 传统 Material 材质管理
- [x] MaterialProperty 材质属性系统
- [x] 动态材质切换
- [x] 自定义材质注册
- [x] **组件合并**: MaterialControl 已合并到 ControlPanel ✅
- [x] **状态管理**: 将材质控制逻辑移到 Pinia store
- [x] **代码重构**: 着色器代码统一管理（shaders.js）✅
- [x] **错误修复**: 修复模块间引用错误 ✅
- [ ] **组件化需求**: 封装 `MaterialPropertyEditor` 组件

### 3. 抛物线工具模块

#### 3.1 抛物线生成
- [x] 基础抛物线轨迹计算
- [x] 自动高度计算
- [x] 批量抛物线生成
- [x] 抛物线参数配置
- [ ] **组件化需求**: 封装 `ParabolaGenerator` 组件
- [ ] **组件化需求**: 封装 `ParabolaConfigPanel` 组件

#### 3.2 抛物线材质
- [x] 抛物线飞线材质
- [x] 抛物线脉冲材质
- [x] 材质参数动态调整
- [ ] **组件化需求**: 封装 `ParabolaMaterialEditor` 组件

### 4. 控制面板模块

#### 4.1 基础控制
- [x] 材质模式切换
- [x] 目标类型筛选
- [x] 关系类型筛选
- [ ] **组件化需求**: 封装 `ControlPanel` 组件（已存在，需优化）
- [ ] **组件化需求**: 封装 `FilterPanel` 组件

#### 4.2 高级控制
- [ ] 时间轴控制
- [ ] 动画播放控制
- [ ] 场景保存/加载
- [ ] **组件化需求**: 封装 `TimelineControl` 组件
- [ ] **组件化需求**: 封装 `AnimationControl` 组件
- [ ] **组件化需求**: 封装 `SceneManager` 组件

### 5. 数据管理模块

#### 5.1 数据结构
- [x] 目标数据结构
- [x] 关系数据结构
- [x] 配置数据结构
- [ ] **组件化需求**: 封装 `DataProvider` 组件
- [ ] **组件化需求**: 封装 `DataValidator` 组件

#### 5.2 数据操作
- [x] 数据加载
- [x] 数据筛选
- [x] 数据更新
- [ ] 数据导入/导出
- [ ] **组件化需求**: 封装 `DataImporter` 组件
- [ ] **组件化需求**: 封装 `DataExporter` 组件

## 组件化架构设计

### 架构原则

#### 组件分层
- **UI组件层**：纯展示组件，只负责渲染，通过props接收数据
- **业务组件层**：包含业务逻辑的组件，负责数据处理和状态管理
- **容器组件层**：组合多个组件，协调组件间通信

#### 数据流向
- 数据从父组件通过props向下传递
- 事件通过emit向上传递
- 全局状态通过Pinia管理

### 核心组件层次结构

```
App (主容器)
├── ControlPanel (控制面板 - 业务组件) ✅ 已集成材质控制功能
│   ├── FilterPanel (筛选面板)
│   ├── TimelineControl (时间轴控制)
│   ├── AnimationControl (动画控制)
│   ├── MaterialModeToggle (材质模式切换 - 内置)
│   ├── MaterialTypeSelector (材质类型选择 - 内置)
│   ├── SpeedControl (速度控制 - 内置)
│   ├── OpacityControl (透明度控制 - 内置)
│   └── ColorPresets (颜色预设 - 内置)
├── TargetPanel (目标面板 - 业务组件)
│   ├── TargetList (目标列表)
│   └── TargetInfoPanel (信息面板)
├── DataVisualization (纯UI组件) ✅ 已完成
│   ├── CesiumViewer (地图容器)
│   ├── TargetLayer (目标图层)
│   │   └── TargetMarker (目标标记)
│   └── RelationLayer (关系图层)
│       └── RelationLine (关系连线)
├── ParabolaTools (抛物线工具 - 业务组件)
│   ├── ParabolaGenerator (抛物线生成器)
│   ├── ParabolaConfigPanel (配置面板)
│   └── ParabolaMaterialEditor (材质编辑器)
└── DataManager (数据管理 - 业务组件)
    ├── DataProvider (数据提供者)
    ├── DataValidator (数据验证器)
    ├── DataImporter (数据导入器)
    └── DataExporter (数据导出器)
```

### 组件设计原则

1. **单一职责**: 每个组件只负责一个特定功能
2. **可复用性**: 组件应该可以在不同场景下复用
3. **可配置性**: 通过 props 提供灵活的配置选项
4. **事件驱动**: 使用事件进行组件间通信
5. **状态管理**: 使用 Pinia 进行全局状态管理
6. **分层清晰**: UI组件与业务组件分离，职责明确

## 技术栈

- **前端框架**: Vue 3 (Composition API)
- **3D 引擎**: Cesium
- **状态管理**: Pinia
- **构建工具**: Vite
- **代码规范**: ESLint + Prettier

## 开发规范

### 文件组织

```
src/
├── components/          # 组件目录
│   ├── ui/             # 纯UI组件
│   │   ├── DataVisualization.vue
│   │   ├── TargetMarker.vue
│   │   ├── RelationLine.vue
│   │   └── common/     # 通用UI组件
│   └── business/       # 业务组件
│       ├── ControlPanel.vue
│       ├── TargetPanel.vue
│       ├── ParabolaTools.vue
│       └── tools/      # 工具组件
├── containers/         # 容器组件
│   └── App.vue
├── composables/        # 组合式函数
├── utils/              # 工具函数
├── stores/             # 状态管理
├── types/              # TypeScript 类型定义
└── examples/           # 示例代码
```

### 组件命名规范

- 组件文件名使用 PascalCase
- 组件内部使用 Composition API
- Props 使用 camelCase
- Events 使用 kebab-case

### 代码质量要求

- 所有组件必须有 TypeScript 类型定义
- 所有公共方法必须有 JSDoc 注释
- 组件必须有单元测试
- 遵循 Vue 3 最佳实践

## 组件开发规范

### UI组件规范
- **纯净性**：不包含业务逻辑，只负责展示
- **数据接收**：通过props接收所有需要的数据
- **事件传递**：通过emit向父组件传递事件
- **样式隔离**：使用scoped样式，避免全局污染
- **可复用性**：设计时考虑复用性，避免硬编码

### 业务组件规范
- **职责单一**：每个组件只负责一个特定的业务功能
- **状态管理**：使用Pinia进行全局状态管理
- **数据处理**：在组件内部处理业务逻辑
- **错误处理**：包含完整的错误处理机制

### 容器组件规范
- **组件组合**：负责组合多个子组件
- **数据流控制**：控制数据在组件间的流动
- **事件协调**：协调子组件间的事件通信
- **生命周期管理**：管理子组件的生命周期

## 下一步开发计划

### Phase 1: 架构重构（当前阶段）
1. 将 `DataVisualization` 重构为纯UI组件
2. 将控制面板和目标面板移到 `App.vue`
3. 调整文件夹结构，区分UI组件和业务组件
4. 优化数据流，通过props传递数据

### Phase 2: 基础组件封装
1. 封装 `TargetMarker` 组件
2. 封装 `RelationLine` 组件
3. 封装 `MaterialSelector` 组件
4. 优化现有 `ControlPanel` 组件

### Phase 3: 高级功能组件
1. 封装 `ParabolaGenerator` 组件
2. 封装 `MaterialPropertyEditor` 组件
3. 封装 `TimelineControl` 组件
4. 封装 `AnimationControl` 组件

### Phase 4: 数据管理组件
1. 封装 `DataProvider` 组件
2. 封装 `DataImporter/Exporter` 组件
3. 封装 `DataValidator` 组件
4. 完善数据流管理

### Phase 5: 性能优化与测试
1. 组件性能优化
2. 单元测试覆盖
3. 集成测试
4. 文档完善

## 技术修复记录

### v1.2.3 代码重构与错误修复详情

#### 问题描述
1. **着色器代码重复**: `materials.js` 和 `materialProperties.js` 中存在重复的 GLSL 着色器代码定义
2. **模块引用错误**: 多个文件中存在错误的导入路径，导致运行时错误

#### 解决方案
1. **创建统一着色器管理模块**:
   - 新建 `src/utils/shaders.js` 文件
   - 集中管理所有 GLSL 着色器源码
   - 提供 `createMaterialConfig` 函数统一创建材质配置

2. **修复模块引用关系**:
   - `materialPropertyManager.js`: 移除重复的材质注册代码
   - `materials.js`: 修复 `createPulseLineMaterial` 和 `materialPropertyManager` 的导入路径
   - `materialPropertyExample.js`: 修复相关函数的导入路径

#### 技术优势
- **代码复用**: 消除着色器代码重复定义
- **统一管理**: 所有着色器源码集中维护
- **易于扩展**: 添加新着色器类型更加简单
- **维护性强**: 修改着色器只需在一个地方进行

## 扩展指南

每次新增功能时，请按照以下步骤：

1. **需求分析**: 在本文档中添加新的功能需求
2. **组件设计**: 确定是否需要新的组件或修改现有组件
3. **接口定义**: 定义组件的 Props、Events 和 Slots
4. **实现开发**: 按照开发规范实现组件
5. **测试验证**: 编写单元测试和集成测试
6. **文档更新**: 更新本需求文档和组件文档

## 版本历史

- v1.0.0: 初始版本，包含基础地图可视化功能
- v1.1.0: 添加抛物线工具和 MaterialProperty 系统
- v1.2.0: 组件化重构第一阶段 - 完成基础架构重构
- v1.2.1: 材质控制系统重构 - 添加 MaterialControl 组件和 Pinia 状态管理
- v1.2.2: 组件合并与优化 - 将 MaterialControl 组件合并到 ControlPanel，实现统一控制面板
- v1.2.3: 代码重构与错误修复 - 着色器代码统一管理，修复模块间引用错误
- v1.3.0: (计划中) 组件化重构第二阶段

---

**最后更新**: 2024年12月
**维护者**: AI Assistant
**状态**: 活跃开发中